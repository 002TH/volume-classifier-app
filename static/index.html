<!DOCTYPE html>
<html>
<head>
    <title>SOLUSDT Volume Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --container-bg: white;
            --text-color: #333;
            --hr-color: #ddd;
        }
        
        .dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #f0f0f0;
            --hr-color: #444;
        }
        
        body {
            font-family: sans-serif;
            padding: 20px;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.3s, color 0.3s;
        }
        
        .container {
            background: var(--container-bg);
            padding: 20px;
            border-radius: 10px;
            transition: background 0.3s;
        }
        
        canvas { margin-top: 20px; }
        select { 
            padding: 8px; 
            margin-right: 10px;
            background: var(--container-bg);
            color: var(--text-color);
            border: 1px solid var(--hr-color);
        }
        
        hr { border-color: var(--hr-color); }
        
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--container-bg);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">ðŸŒ™</span>
        <span id="theme-text">Dark Mode</span>
    </button>
    
    <div class="container">
        <h2>ðŸ”¼ Real-Time Volume Pressure</h2>
        <div><strong>Status:</strong> <span id="label"></span></div>
        <div><strong>Open:</strong> <span id="open"></span> | <strong>Close:</strong> <span id="close"></span></div>
        <div><strong>Volume:</strong> <span id="volume"></span> | <strong>Time:</strong> <span id="time"></span></div>
        <canvas id="topChart" height="150"></canvas>

        <hr>

        <h2>ðŸ”½ Historical Volume Pressure</h2>
        <label>Select Timeframe:</label>
        <select id="timeframe" onchange="changeTimeframe()">
            <option value="1m">1 Minute</option>
            <option value="3m">3 Minute</option>
            <option value="5m" selected>5 Minute</option>
            <option value="15m">15 Minute</option>
        </select>
        <canvas id="bottomChart" height="200"></canvas>
    </div>

    <script>
        // Theme management
        function applyTheme(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
                document.getElementById('theme-text').textContent = 'Light Mode';
                
                // Update charts for dark mode
                Chart.defaults.color = '#f0f0f0';
                Chart.defaults.borderColor = '#444';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('theme-icon').textContent = 'ðŸŒ™';
                document.getElementById('theme-text').textContent = 'Dark Mode';
                
                // Update charts for light mode
                Chart.defaults.color = '#666';
                Chart.defaults.borderColor = 'rgba(0, 0, 0, 0.1)';
            }
            
            // Re-render charts with new theme
            if (topChart) topChart.update();
            if (bottomChart) bottomChart.update();
        }

        function toggleTheme() {
            const isDark = !document.body.classList.contains('dark-mode');
            applyTheme(isDark);
            localStorage.setItem('darkMode', isDark);
        }

        // Initialize theme from localStorage or prefer-color-scheme
        function initTheme() {
            const savedTheme = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme !== null) {
                applyTheme(savedTheme === 'true');
            } else if (prefersDark) {
                applyTheme(true);
            }
        }

        // Chart initialization and other existing code...
        const topCtx = document.getElementById('topChart').getContext('2d');
        const bottomCtx = document.getElementById('bottomChart').getContext('2d');
        let historyInterval;
        let currentTimeframe = '5m'; // Default timeframe

        let topChart = new Chart(topCtx, {
            type: 'bar',
            data: {
                labels: ['Current'],
                datasets: [{
                    label: 'Volume',
                    data: [0],
                    backgroundColor: '#ccc'
                }]
            },
            options: { 
                responsive: true,
                scales: {
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });

        let bottomChart = new Chart(bottomCtx, {
            type: 'bar',
            data: { labels: [], datasets: [{ label: 'Volume', data: [], backgroundColor: [] }] },
            options: { 
                responsive: true,
                scales: {
                    x: {
                        ticks: {
                            autoSkip: true,
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                }
            }
        });

        function changeTimeframe() {
            currentTimeframe = document.getElementById('timeframe').value;
            clearInterval(historyInterval);
            startHistoryUpdates();
        }

        function startHistoryUpdates() {
            loadHistory();
            const intervalTime = getUpdateInterval(currentTimeframe);
            historyInterval = setInterval(loadHistory, intervalTime);
        }

        function getUpdateInterval(timeframe) {
            switch(timeframe) {
                case '1m': return 30000;
                case '3m': return 60000;
                case '5m': return 90000;
                case '15m': return 180000;
                default: return 60000;
            }
        }

        async function updateTop() {
            try {
                const res = await fetch('/realtime?timeframe=' + currentTimeframe);
                const data = await res.json();
                document.getElementById('label').textContent = data.label;
                document.getElementById('volume').textContent = data.volume.toLocaleString();
                document.getElementById('open').textContent = data.open;
                document.getElementById('close').textContent = data.close;
                document.getElementById('time').textContent = data.time;
                topChart.data.datasets[0].data = [data.volume];
                topChart.data.datasets[0].backgroundColor = data.color;
                topChart.update();
            } catch (error) {
                console.error('Error updating top chart:', error);
            }
        }

        async function loadHistory() {
            try {
                const res = await fetch('/historical?timeframe=' + currentTimeframe);
                const history = await res.json();
                const labels = history.map(h => h.time);
                const volumes = history.map(h => h.volume);
                const colors = history.map(h => h.color);
                bottomChart.data.labels = labels;
                bottomChart.data.datasets[0].data = volumes;
                bottomChart.data.datasets[0].backgroundColor = colors;
                bottomChart.update();
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Initialize everything when page loads
        window.onload = () => {
            initTheme();
            updateTop();
            startHistoryUpdates();
            setInterval(updateTop, 3000);
        };
    </script>
</body>
</html>