<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SOLUSDT Volume Pressure Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial;
      background: #f0f0f0;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
    }
    .panel {
      margin-bottom: 40px;
    }
    .chart-box {
      height: 300px;
      margin-top: 10px;
    }
    .pressure {
      font-size: 18px;
      font-weight: bold;
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    select, button {
      padding: 8px 12px;
      margin-right: 10px;
    }
    .section-title {
      margin-bottom: 5px;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align:center;">SOL/USDT Volume Pressure Dashboard</h1>

    <!-- Controls -->
    <div>
      <select id="timeframe" onchange="onTimeframeChange()">
        <option value="1m" selected>1 Minute</option>
        <option value="3m">3 Minutes</option>
        <option value="5m">5 Minutes</option>
        <option value="15m">15 Minutes</option>
      </select>
      <button onclick="updateTop()">Refresh Now</button>
      <span id="lastUpdated" style="font-weight:bold;"></span>
    </div>

    <!-- Top Panel -->
    <div class="panel">
      <div class="section-title">Current Candle Pressure (updates every 3s)</div>
      <div class="pressure" id="pressureBox">Loading...</div>
      <div class="chart-box">
        <canvas id="topChart"></canvas>
      </div>
    </div>

    <!-- Bottom Panel -->
    <div class="panel">
      <div class="section-title">Historical Volume Pressure</div>
      <div class="chart-box">
        <canvas id="bottomChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    let topChart, bottomChart, historyInterval;

    // Initialize charts
    function initCharts() {
      const ctxTop = document.getElementById('topChart').getContext('2d');
      const ctxBottom = document.getElementById('bottomChart').getContext('2d');

      topChart = new Chart(ctxTop, {
        type: 'bar',
        data: {
          labels: ['Volume'],
          datasets: [{
            label: 'Current Volume',
            data: [0],
            backgroundColor: '#ccc'
          }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      bottomChart = new Chart(ctxBottom, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Historical Volume',
            data: [],
            backgroundColor: []
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Volume: ${context.raw.toLocaleString()}`;
                }
              }
            }
          },
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: true } },
            y: { beginAtZero: false }
          }
        }
      });
    }

    // Fetch current candle pressure
    async function updateTop() {
      try {
        const tf = document.getElementById('timeframe').value;
        const res = await fetch('/data?timeframe=' + tf);
        const d = await res.json();
        if (d.error) return;

        topChart.data.datasets[0].data = [d.current_volume];
        topChart.data.datasets[0].backgroundColor = d.color;
        topChart.update();

        document.getElementById('pressureBox').textContent = d.pressure;
        document.getElementById('pressureBox').style.color = d.color;
        document.getElementById('lastUpdated').textContent = `Last: ${d.timestamp}`;
      } catch (e) {
        console.error('Top update error:', e);
      }
    }

    // Fetch historical data
    async function loadHistory() {
      const tf = document.getElementById('timeframe').value;
      const res = await fetch('/historical?timeframe=' + tf);
      const history = await res.json();

      const labels = history.map(h => h.time);
      const volumes = history.map(h => h.volume);
      const colors = history.map(h => h.color);

      bottomChart.data.labels = labels;
      bottomChart.data.datasets[0].data = volumes;
      bottomChart.data.datasets[0].backgroundColor = colors;
      bottomChart.update();

      startHistoryAutoUpdate();
    }

    // Set interval for auto-history update based on timeframe
    function startHistoryAutoUpdate() {
      if (historyInterval) clearInterval(historyInterval);
      const tf = document.getElementById('timeframe').value;

      let seconds = 60;
      if (tf === "3m") seconds = 180;
      else if (tf === "5m") seconds = 300;
      else if (tf === "15m") seconds = 900;

      historyInterval = setInterval(loadHistory, seconds * 1000);
    }

    function onTimeframeChange() {
      loadHistory();
      updateTop();
    }

    window.onload = () => {
      initCharts();
      updateTop();
      loadHistory();
      setInterval(updateTop, 3000); // Always keep current candle updating
    };
  </script>
</body>
</html>